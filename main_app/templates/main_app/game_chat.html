{% extends 'main_app/base.html' %}

{% load static %}
{% load i18n %}

{% block head %}
<style>
  textarea {
    -moz-border-radius: 7px;
    -webkit-border-radius: 7px;
    -khtml-border-radius: 7px;
    border-radius: 7px;
    width: 100%;
    color: rgb(210, 210, 210);
    background-color: #181618;
    border: 2px solid rgb(90, 90, 90);
    /* отключение обводки при фокусе окна */
    outline: none;
    -moz-appearance: none;
    /* запретить регулировать размер окна */
    resize: none;
    /* скролл полоса отображается даже до переполнения окна контентом */
    /* overflow-y: scroll; */
  }
  #go-to-bottom {
    color: #fff;
    border-radius: 5px;
    border: 1px solid rgb(60, 60, 60);
    background-color: rgba(0, 0, 0, 0.6);
    position: relative;
    bottom: 80px;
    left: 35%;
    visibility: hidden;
  }
  #go-to-bottom:hover {
    background-color: rgba(50, 50, 50, 0.9);
  }
  /* Если мы на мобильном */
  @media screen and (max-width: 800px) {
    #go-to-bottom {
      max-width: 88%;
      left: 3.5%;
    }
  }
  #wotlk-x1, #wotlk_x5_alliance, #wotlk_x5_horde,
  #wotlk_x100_alliance, #wotlk_x100_horde, #wotlk-fun {
    color: #fff;
    border-radius: 5px;
    border: 1px solid rgb(60, 60, 60);
    background-color: rgba(0, 0, 0, 0.6);
    transition: all .3s ease;
    margin-right: 5px;
    margin-bottom: 10px;
  }
  #wotlk-x1:hover, #wotlk_x5_alliance:hover, #wotlk_x5_horde:hover,
  #wotlk_x100_alliance:hover, #wotlk_x100_horde:hover, #wotlk-fun:hover {
    border-color: rgba(0, 200, 255, 1);
    box-shadow: inset 0 0 5px rgba(0, 200, 255, 1);
  }
  .servers-text[_ngcontent-xcm-c63] {
    position: absolute;
    font-size: 12px;
    margin-top: -18px;
    margin-left: 1px;
    text-align: center;
    color: #a0a0a0;
  }
</style>

<style>
  .checkBox[_ngcontent-xpp-c82] {
    left: 1.5px;
    top: 3px;
    width: 62px;
    height: 20px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(0, 200, 255, 1);
    box-shadow: inset 0 0 5px rgba(0, 200, 255, 1);
    position: relative;
    display: inline-block;
    border-radius: 5px
  }
  .checkBox[_ngcontent-xpp-c82]:after { 
    content: "{% trans 'НЕТ' %}";
    color: red;
    top: -3px;
    right: 4.5px
  }
  .checkBox[_ngcontent-xpp-c82]:after,
  .checkBox[_ngcontent-xpp-c82]:before {
    position: absolute;
    z-index: 0;
    font: 12px/26px Arial, sans-serif;
    font-weight: 700
  }
  .checkBox[_ngcontent-xpp-c82]:before {
    content: "{% trans 'ДА' %}";
    color: #28e219;
    top: -4px;
    left: 7.5px
  }
  .checkBox[_ngcontent-xpp-c82] label[_ngcontent-xpp-c82] {
    display: block;
    width: 26px;
    height: 13px;
    cursor: pointer;
    position: absolute;
    top: 2.4px;
    left: 3.5px;
    z-index: 1;
    border-radius: 4px;
    transition: all .3s ease;
    background: rgb(0, 110, 140);
    border: 1px solid rgba(0, 200, 255, 1);
    box-shadow: inset 0 0 5px rgba(0, 200, 255, 1);
  }
  .checkBox[_ngcontent-xpp-c82] label[_ngcontent-xpp-c82]:hover {
    background: rgb(0, 160, 204);
  }
  .checkBox[_ngcontent-xpp-c82] input[type=checkbox][_ngcontent-xpp-c82] {
    visibility: hidden
  }
  .checkBox[_ngcontent-xpp-c82] input[type=checkbox][_ngcontent-xpp-c82]:checked+label[_ngcontent-xpp-c82] {
    left: 30.5px
  }
  .only-twitch-text[_ngcontent-xpp-c82] {
    position: absolute;
    font-size: 12px;
    margin-top: -33px;
    margin-left: -11.5px;
    max-width: 86px;
    text-align: center;
    color: #a0a0a0;
  }
</style>

<style>
  input[_ngcontent-xcm-c63] {
    color: #dadada;
    text-align: center;
    font-family: sans-serif;
    font-size: 16px;
    outline:none;
  }
  input[_ngcontent-xcm-c63]::-moz-placeholder {
    color: #878787
  }
  input[_ngcontent-xcm-c63]::placeholder {
    color: #878787
  }
  .player-nickname {
    width: 160px;
    height: 27px;
    background-color: rgba(0, 0, 0, 0.6);
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.4);
    transition: all .3s ease;
  }
  .player-nickname-text[_ngcontent-xcm-c63] {
    position: absolute;
    font-size: 12px;
    margin-top: -36px;
    margin-left: 17px;
    max-width: 123px;
    text-align: center;
    color: #a0a0a0;
  }
</style>

<style>
  .nickname-delete-btn {
    font-size: 19px;
    margin: auto;
    position: relative;
    right: 25px;
    bottom: 10px;
    opacity: 0.5;
    cursor: pointer;
    width: 0;
    height: 0;
    visibility: hidden;
  }
  .nickname-delete-btn:hover {
    color: red;
    opacity: 1;
  }
</style>

<style>
  .player-nickname-text-and-input, .only-twitch-text-and-input, .servers-text-and-button {
    display: inline-block;
    width: auto;
  }
  /* Если мы на мобильном */
  @media screen and (max-width: 800px) {
    .player-nickname-text-and-input, .only-twitch-text-and-input {
      margin-top: 25px;
      margin-bottom: 10px;
    }
    .nickname-delete-btn {
      bottom: 11px;
    }
  }
</style>
{% endblock %}

{% block body %}
<app-game-chat _nghost-gox-c51="">
  <div _ngcontent-gox-c51="" class="bg-check page-size px-3 py-3">
    <div _ngcontent-gox-c51="" class="pb-5">
      <h2 _ngcontent-gox-c51="" class="my-4" style="padding-bottom: 15px;">{% trans 'Игровой чат' %}</h2>
      <div _ngcontent-gox-c51="">

        <div _ngcontent-gox-c51="" class="chat-buttons-box">

          <div class="servers-text-and-button">
            <span _ngcontent-xcm-c63="" class="servers-text">{% trans 'Серверы:' %}</span>
            <button id="wotlk-x1" value="wotlk-x1">wotlk-x1</button>
          </div>

          <button id="wotlk_x5_alliance" value="wotlk_x5_alliance">wotlk-x5-alliance</button>
          <button id="wotlk_x5_horde" value="wotlk_x5_horde">wotlk-x5-horde</button>
          <button id="wotlk_x100_alliance" value="wotlk_x100_alliance">wotlk-x100-alliance</button>
          <button id="wotlk_x100_horde" value="wotlk_x100_horde">wotlk-x100-horde</button>
          <button id="wotlk-fun" value="wotlk-fun">wotlk-fun</button>

          <div class="player-nickname-text-and-input">
            <span _ngcontent-xcm-c63="" class="player-nickname-text">{% trans 'Фильтрация по никнейму игрока' %}</span>
            <input _ngcontent-xcm-c63="" class="player-nickname" type="text"
              maxlength="12" placeholder="{% trans 'Никнейм игрока' %}"
              onkeyup="this.value=this.value.replace(/[^\а-яёА-ЯЁa-zA-Z]/g,'');">
              <i _ngcontent-xcm-c57="" class="material-icons nickname-delete-btn">close</i>
          </div>

          <div class="only-twitch-text-and-input">
            <span _ngcontent-xpp-c82="" class="only-twitch-text">{% trans 'Только ссылки на' %} Twitch</span>
            <div _ngcontent-xpp-c82="" class="checkBox">
              <input type="checkbox" _ngcontent-xpp-c82="" id="only-twitch">
              <label _ngcontent-xpp-c82="" for="only-twitch"></label>
            </div>
          </div>

        </div>

        <textarea id="chat-log" rows="20" readonly=""></textarea>
        <!-- <textarea id="chat-log" rows="20" disabled></textarea> -->

        <button id="go-to-bottom">
          <i _ngcontent-xcm-c57="" class="material-icons"
          style="font-size: 23px; margin: auto; color: #fff;">pause</i>
          {% trans 'Чат приостановлен из-за прокрутки' %}
        </button>

        <script>
          // https://learn.javascript.ru/websockets
          const ws_scheme = window.location.protocol == "https:" ? "wss://" : "ws://";
          {% if debug_mode %}
            const chatSocket = new WebSocket(ws_scheme + window.location.host + "/ws/game-chat/"); // DEV
          {% else %}
            const chatSocket = new WebSocket(ws_scheme + window.location.host + ":8001/ws/game-chat/"); // PROD
          {% endif %}


          const chat_log_area = $('#chat-log');
          const chat_btns_box_btn = $('.chat-buttons-box button');
          const player_nickname_input = $('.player-nickname');
          const nickname_del_btn = $('.nickname-delete-btn');
          const go_to_bottom = $('#go-to-bottom');
          const only_twitch = document.querySelector('#only-twitch');
          const wotlk_x1 = document.getElementById('wotlk-x1');

          const storage_server_name = window.localStorage.getItem('server_name');
          const storage_only_twitch_checked = JSON.parse(window.localStorage.getItem('only_twitch_checked'));
          const storage_player_nickname = window.localStorage.getItem('player_nickname');

          let first_line = true;
          let nick_del_btn_lock = false;

          let chat_bottom = true;
          let animation_state = false;
          let scroll_position = 0;


          chat_btns_box_btn.on('click', function(event) {
            chat_send_handler(event.currentTarget, event);
          });

          function chat_send_handler(button, event) {
            if (!chatSocket.readyState) return;

            chat_buttons_handler(button);

            // очистить чат и напечатать текущий выбранный сервер
            first_line = true;
            chat_log_area[0].value = "{% trans 'Чат сервера: ' %}" + button.value + '\n';

            if (event) window.localStorage.setItem('server_name', button.value);

            chatSocket.send(JSON.stringify({
                'server_name': button.value,
                'player_nickname': window.localStorage.getItem('player_nickname'),
                'only_twitch': JSON.parse(window.localStorage.getItem('only_twitch_checked'))
            }));
          };
        </script>

        <script>
          only_twitch.addEventListener('input', function(event) {
            if (!chatSocket.readyState) return;

            window.localStorage.setItem('only_twitch_checked', only_twitch.checked);

            chatSocket.send(JSON.stringify({
              'player_nickname': window.localStorage.getItem('player_nickname'),
              'only_twitch': only_twitch.checked
            }));
          });
        </script>

        <script>
          function set_player_nickname() {
            if (!chatSocket.readyState) return;

            if (player_nickname_input[0].value.match(/[^\а-яёА-ЯЁa-zA-Z]/g)) return;

            let clean_player_nickname = player_nickname_input[0].value.replace(/[^\а-яёА-ЯЁa-zA-Z]/g, '');

            if (clean_player_nickname) {
              const first_char = clean_player_nickname[0].toUpperCase();
              const other_chars = clean_player_nickname.slice(1, clean_player_nickname.length).toLowerCase();
              clean_player_nickname = first_char + other_chars;

              player_nickname_input.css("border-color", "#28e219");
              player_nickname_input.css("box-shadow", "inset 0 0 5px #28e219");
              nickname_del_btn.css("visibility", "visible");
            } else {
              player_nickname_input.css("border-color", "rgba(255, 255, 255, 0.4)");
              player_nickname_input.css("box-shadow", "inset 0 0 5px rgba(255, 255, 255, 0.4)");
              nickname_del_btn.css("visibility", "hidden");

              nick_del_btn_lock = false;
            };

            window.localStorage.setItem('player_nickname', clean_player_nickname);

            chatSocket.send(JSON.stringify({
              'player_nickname': clean_player_nickname,
              'only_twitch': JSON.parse(window.localStorage.getItem('only_twitch_checked'))
            }));
          };
          const debounce_set_player_nickname = debounce(set_player_nickname, 400);

          player_nickname_input.on('change input', function(event) {
            debounce_set_player_nickname();
          });

          nickname_del_btn.click(function(event) {
            if (nick_del_btn_lock) return;

            nick_del_btn_lock = true;
            player_nickname_input[0].value = '';

            // вручную генерируем ивент для того чтобы сработал обработчик никнейма
            player_nickname_input[0].dispatchEvent(new Event('change'));
          });
        </script>

        <script>
          chatSocket.onopen = function(event) {

            chat_send_handler(storage_server_name ? document.getElementById(storage_server_name) : wotlk_x1);

            if (storage_only_twitch_checked) only_twitch.checked = true;

            if (storage_player_nickname) {
              player_nickname_input[0].value = storage_player_nickname;
              player_nickname_input.css("border-color", "#28e219");
              player_nickname_input.css("box-shadow", "inset 0 0 5px #28e219");
              nickname_del_btn.css("visibility", "visible");
            } else {
              player_nickname_input.css("border-color", "rgba(255, 255, 255, 0.4)");
              player_nickname_input.css("box-shadow", "inset 0 0 5px rgba(255, 255, 255, 0.4)");
            };

            chatSocket.send(JSON.stringify({
              'player_nickname': storage_player_nickname ? storage_player_nickname : '',
              'only_twitch': storage_only_twitch_checked ? true : false
            }));
          };
        </script>

        <script>
          chatSocket.onmessage = function(event) {

            const data = JSON.parse(event.data);

            if (first_line) {
              first_line = false;
              chat_log_area[0].value += data.message;
            } else {
              chat_log_area[0].value += ('\n' + data.message);
            };

            scroll_chat_text();
          };
        </script>

        <script>
          function chat_buttons_handler(button) {

            chat_btns_box_btn.each(function(index, element) {
              element = $(element);

              if (element[0] != button) {
                element.css("border-color", "rgb(60, 60, 60)");
                element.css("box-shadow", "none");
                element.css("pointer-events", "all");
                element.hover(
                  function(event) { // mouseenter
                    element.css("border-color", "rgba(0, 200, 255, 1)");
                    element.css("box-shadow", "inset 0 0 5px rgba(0, 200, 255, 1)");
                  },
                  function(event) { // mouseleave
                    element.css("border-color", "rgb(60, 60, 60)");
                    element.css("box-shadow", "none");
                  },
                );
              } else {
                element.css("border-color", "rgba(0, 200, 255, 1)");
                element.css("box-shadow", "inset 0 0 5px rgba(0, 200, 255, 1)");
                element.css("pointer-events", "none");
                element.hover(
                  function(event) { // mouseenter
                    element.css("border-color", "rgba(0, 200, 255, 1)");
                    element.css("box-shadow", "inset 0 0 5px rgba(0, 200, 255, 1)");
                  },
                );
              };
            });
          };
        </script>

        <script>
          jQuery(function($) {
            chat_log_area.on('scroll', function(event) {

              // для отключения автоматической прокрутки лучше использовать ивент scroll а не wheel
              // т.к. scroll работает как с мышью так и с тачскрином, wheel только с мышью.
              const scroll_top = $(this).scrollTop();
              if (animation_state && scroll_top < scroll_position) {
                $(this).stop();
                animation_state = false;
              };
              scroll_position = scroll_top;

              const check_location = $(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight;
              if (check_location) {
                chat_bottom = true;
                go_to_bottom.css("visibility", "hidden");

              } else if (!check_location && !animation_state) {
                chat_bottom = false;
                go_to_bottom.css("visibility", "visible");
              };
            });
          });

          function scroll_chat_text() {
            if (!chat_bottom) return;

            // https://basicweb.ru/jquery/jquery_effect_animate.php
            chat_log_area.animate(
              { scrollTop: chat_log_area.get(0).scrollHeight },
              { duration: 600, queue: false,
                start: function(event) { animation_state = true; },
                complete: function(event) { animation_state = false; },
              },
            );
          };

          go_to_bottom.click(function(event) {
            chat_log_area.animate(
              { scrollTop: chat_log_area.get(0).scrollHeight, },
              { duration: 600, queue: false, },
            );
          });
        </script>

      </div>
    </div>
  </div>
</app-game-chat>
{% endblock %}
