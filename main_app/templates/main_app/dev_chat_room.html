{% extends 'main_app/base.html' %}

{% load static %}
{% load i18n %}

{% block head %}
<style>
  #background-video, #bg-video-btn {
    display: none;
  }
  .toolbar-container[_ngcontent-gox-c6] {
    display: none !important;
  }
  body {
    background-color: #303130;
  }
</style>

<style>
  .btn-custom2[_ngcontent-gox-c64] {
    height: 46px;
    padding: 0 10px;
    font-size: 14px;
    line-height: 43px;
    cursor: Pointer;
    width: auto;
    color: #dadada;
    background-color: #181618;
    border: 1px solid #454545;
    border-radius: 0px;
    transition: all 0.3s ease;
  }
  .btn-custom2[_ngcontent-gox-c64]:hover {
    border: 1px solid #fff;
  }
  #login-popup[_ngcontent-gox-c60] {
    display: none;
    position: relative;
    max-width: 400px;
    top: 35px;
    margin-top: 120px;
    margin-left: auto;
    margin-right: auto;
    height: auto;
    border: 2px solid #1fb8ff;
    border-radius: 4px 4px 4px 4px;
    background-color: rgba(0, 0, 0, 1);
    z-index: 20000;
    font-size: 12px;
    line-height: 19px;
    text-align: center;
    box-shadow: 0 0 30px 10px #ffffff12
  }
  input[_ngcontent-xcm-c64]:focus,
  input[_ngcontent-xcm-c64] {
    background-color: #181618;
    border: 1px solid #454545;
    font-family: Poppins;
    color: #dadada;
    box-shadow: none;
    text-align: center;
    width: 100%;
    max-width: 300px;
    padding: 10px;
    outline: none
  }
  input[_ngcontent-xcm-c64]::-moz-placeholder {
    color: #4b4b4b
  }
  input[_ngcontent-xcm-c64]::placeholder {
    color: #4b4b4b
  }
  fieldset[_ngcontent-xcm-c64] {
    border: medium none !important;
    margin: 0 0 10px;
    min-width: 100%;
    padding: 0;
    width: 100%
  }
  .disabled[_ngcontent-gox-c64] {
    opacity: .4;
    cursor: not-allowed;
  }
  .disabled[_ngcontent-gox-c64]:hover {
    background-color: #676af7;
  }
</style>

<style>
  option {
    font-weight: 600;
  }
  .programming-languages, .select-pixels {
    font-weight: 600;
    color: rgb(185, 185, 185);
    background-color: #181618;
    border-color: #454545;
    cursor: pointer;
    transition: all 0.3s ease !important;
    outline: none;
    height: 46px;
  }
  .programming-languages {
    border-top-left-radius: 4px;
    border-bottom-left-radius: 4px;
  }
  #close_room_btn, #close_room_info {
    display: none;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
  }
  .close-room-no[_ngcontent-gox-c64] {
    background-color: #2f0000;
  }
  .close-room-no[_ngcontent-gox-c64]:hover {
    border: 1px solid #ff0000;
  }
  .close-room-yes[_ngcontent-gox-c64] {
    background-color: #092d00;
  }
  .close-room-yes[_ngcontent-gox-c64]:hover {
    border: 1px solid #33ff00;
  }
  .programming-languages:hover, .select-pixels:hover {
    border-color: white;
    box-shadow: 0 0 30px 1px #ffffff12;
  }
</style>

<style>
  #dev-chat-container {
    display: none;
  }
  #dev-chat-settings {
    display: inline-flex;
    position: relative;
    left: 44px;
  }
  /* –ï—Å–ª–∏ –º—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
  @media screen and (max-width: 800px) {
    #dev-chat-settings {
      display: inline-block;
      left: 0px;
    }
    .programming-languages {
      margin-bottom: 4px;
    }
    #chat-path-input {
      margin-bottom: 4px;
    }
    /* –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–æ —Ü–∏—Ñ—Ä —Å—Ç—Ä–æ–∫ */
    .ace_gutter-cell {
      padding-left: 4px !important;
    }
  }
</style>

<style type="text/css" media="screen">
  #code_editor {
    /* position: absolute; */
    position: relative;
    width: 100%;
    height: 495px;
    border: 1px solid rgb(31, 184, 255, 0.35);
  }

  /* –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º */
  /* .ace_line {
    pointer-events: auto;
  }
  .ace_line:hover {
    background-color: rgba(100, 100, 100, 0.2);
  } */

  /* –º–∏–∫—Ä–æ–º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
  .ace_mobile-menu {
    display: none;
  }
  .margin-top-l[_ngcontent-gox-c6] {
    margin-top: 25px;
  }
  .margin-bottom-l[_ngcontent-gox-c6] {
    margin-top: 25px;
  }
</style>

<style>
  .player-container{
    display: none;
    /* display: flex; */
    align-items:center;
    margin-left:43px;
    margin-right:43px;
    margin-top: 8px;
  }
  .player__actions{
    display:flex;
  }
  .player__button_type_play,
  .player__button_type_speed,
  .player__button_type_skip {
    height: 35px;
    border: 1px solid #454545;
    background-color: #181618;
    transition: all 0.3s ease;
    color: #dadada;
  }
  .player__button_type_play:hover,
  .player__button_type_speed:hover,
  .player__button_type_skip:hover {
    border: 1px solid #fff;
  }
  .player__button_type_play {
    width: 42px;
    border-top-left-radius: 4px;
    border-bottom-left-radius: 4px;
  }
  .player__button_type_speed {
    width: 54px;
  }
  .player__button_type_skip {
    width: 42px;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
  }
  .disabled_skip {
    opacity: .4;
    cursor: not-allowed;
  }
  .disabled_skip:hover {
    border: 1px solid #454545;
  }
  .player__timeline{
    display:flex;
    box-sizing:border-box;
    width:100%;
    margin-left:15px;
    font-size:15px;
    line-height:32px;
    border:1px solid #454545;
    background-color: #181618;
    border-radius:4px
  }
  .player__progress{
    position:relative;
    display:flex;
    width:100%;
    cursor: pointer;
  }
  .player__pointer{
    position:absolute;
    box-sizing:border-box;
    height:100%;
    background-color: red;
    pointer-events: none;
  }
  .player__frame-container{
    position:relative;
  }
  .player__frame{
    position:absolute;
    top:0;
    bottom:0;
    pointer-events: none;
  }
  .player__time{
    width:100px;
    text-align:center;
    padding-bottom: 1px;
    color: #dadada;
  }
  .player__time_start{
    border-right:1px solid #454545;
  }
  .player__time_end,.player__time_start{
    -webkit-user-select:none;
    -moz-user-select:none;
    -ms-user-select:none;
    user-select:none
  }
  .player__time_end{
    border-left:1px solid #454545;
  }
  /* –ï—Å–ª–∏ –º—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
  @media screen and (max-width: 800px) {
    .player-container{
      display: none;
      /* display: block; */
      margin-left:0px;
      margin-right:0px;
    }
    .player__actions{
      display:flex;
      justify-content: center;
    }
    .player__timeline{
      display:flex;
      width: 95%;
      margin-left: auto;
      margin-right: auto;
      margin-top: 8px;
    }
  }
</style>

<!-- https://fonts.google.com/icons -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
<style>
  .material-symbols-outlined {
    font-variation-settings:
    'FILL' 1,
    'wght' 700,
    'GRAD' 0,
    'opsz' 48;
    position: relative;
    top: 3px;
  }
</style>

<!-- https://github.com/ajaxorg/ace -->
<!-- https://ace.c9.io/#nav=howto -->
<script src="{% static 'main_app/javascript/ace-editor/ace-builds/src-min-noconflict/ace.js' %}"
  type="text/javascript" charset="utf-8"></script>
<!-- https://github.com/convergencelabs/ace-collab-ext -->
<link rel="stylesheet" href="{% static 'main_app/javascript/ace-editor/ace-collab-ext/src/ace-collab-ext.css' %}">
<script src="{% static 'main_app/javascript/ace-editor/ace-collab-ext/src/ace-collab-ext.min.js' %}"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/@convergencelabs/ace-collab-ext@0.6.0/dist/umd/ace-collab-ext.min.js"
  integrity="sha256-GKq7dGDuAyNLhyKy1ruR/HJR2Xgd2oGzTmXH2FhaqPA=" crossorigin="anonymous"></script> -->
{% endblock %}

{% block body %}
<div _ngcontent-gox-c60="" id="login-popup" class="p-3">
  <span _ngcontent-gox-c60="" id="cn-notice-text" style="font-size: 20px; font-weight: 600; line-height: 45px;">
    {% trans '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å' %}
  </span>
  <div _ngcontent-gox-c60="" class="d-block d-md-block mt-2">
    <fieldset _ngcontent-xcm-c64="">
      <div _ngcontent-xcm-c64="" class="form-label ng-star-inserted">&nbsp;</div>
      <input _ngcontent-xcm-c64="" type="text" name="username" maxlength="20" placeholder="{% trans '–í–∞—à–µ –∏–º—è' %}"
        style="font-family: sans-serif; font-size: 16px;" required id="dev_chat_username"
        onkeyup="if (event.keyCode === 13 && event.target.value !== '') { $('#login-popup-btn').click(); };">
    </fieldset>
    <br>
    <button _ngcontent-gox-c64="" id="login-popup-btn" class="mat-tooltip-trigger btn-custom w-100% disabled"
      disabled>{% trans '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' %}</button>
  </div>
</div>

<div id="dev-chat-container">

  <div id="dev-chat-settings">

    <select name="languages" class="programming-languages select-none"
      style="font-family: sans-serif; font-size: 16px;" id="id_programming_languages">
      <option value="plain_text">plain_text</option>
      <option value="c_cpp">c_cpp</option>
      <option value="csharp">csharp</option>
      <option value="css">css</option>
      <option value="golang">golang</option>
      <option value="html">html</option>
      <option value="java">java</option>
      <option value="javascript">javascript</option>
      <option value="json">json</option>
      <option value="jsx">jsx</option>
      <option value="kotlin">kotlin</option>
      <option value="objectivec">objectivec</option>
      <option value="perl">perl</option>
      <option value="php">php</option>
      <option value="python">python</option>
      <option value="ruby">ruby</option>
      <option value="rust">rust</option>
      <option value="scala">scala</option>
      <option value="sql">sql</option>
      <option value="swift">swift</option>
      <option value="xml">xml</option>
      <option value="yaml">yaml</option>
      <option value="dart">dart</option>
      <option value="lua">lua</option>
    </select>

    <select name="pixels" class="select-pixels select-none" id="id_select_pixels"
      style="font-family: sans-serif; font-size: 16px;">
      <option value="14px">14px</option>
      <option value="15px">15px</option>
      <option value="16px">16px</option>
      <option value="17px">17px</option>
      <option value="18px">18px</option>
      <option value="19px">19px</option>
      <option value="20px">20px</option>
      <option value="21px">21px</option>
      <option value="22px">22px</option>
      <option value="23px">23px</option>
      <option value="24px">24px</option>
    </select>

    <input _ngcontent-xcm-c64="" type="text" id="chat-path-input" value=""
      readonly="" style="font-family: sans-serif; font-size: 16px; width: 178px;">

    <a _ngcontent-xpp-c94="" class="info">
      <button _ngcontent-gox-c64="" class="btn-custom2 select-none"
        onclick="copy_text.copy($('#chat-path-input')[0].value);">{% trans '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å' %}</button>
      <span _ngcontent-xpp-c94="" class="info-text"
        style="color: #fff; margin-top: -23px; margin-left: -126px;">{% trans '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É' %}</span>
    </a>

    <button _ngcontent-gox-c64="" class="btn-custom2 select-none close-room-no"
      id="close_room_btn">{% trans '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Ç' %}</button>

    <button _ngcontent-gox-c64="" class="btn-custom2 select-none close-room-yes"
      style="cursor: default; border-color: #454545;"
      id="close_room_info">{% trans '–ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç' %}</button>

    <div id="active-clients" style="font-weight: 600; margin-top: 10px; margin-left: 30px;"></div>

  </div>

  <br><br>

  <div id="code_editor"></div>

  <div class="player-container">
    <div class="player__actions">
      <button class="player__button_type_play select-none"
        type="button" autocomplete="off" aria-pressed="false" tabindex="0" aria-disabled="false">
        <span class="material-symbols-outlined">play_arrow</span>
      </button>
      <button class="player__button_type_speed select-none"
        type="button" autocomplete="off" aria-pressed="false" tabindex="0" aria-disabled="false">
        <span>1x</span>
      </button>
      <button class="player__button_type_skip select-none"
        type="button" autocomplete="off" aria-pressed="false" aria-disabled="true">
        <span class="material-symbols-outlined">fast_forward</span>
      </button>
    </div>

    <div class="player__timeline">
      <div class="player__time player__time_start" draggable="false">00:00</div>
      <div class="player__progress" draggable="false">
        <div class="player__frame-container" draggable="false"></div>
      </div>
      <div class="player__time player__time_end" draggable="false">--:--</div>
    </div>
  </div>

</div>

<script>
  class Player {

    constructor(messages) {
      this.__init__(messages);
      // –∫–æ—Å—Ç—ã–ª—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–∏–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      // –ø–æ–ª—É—á–∞—Ç—å —à–∏—Ä–∏–Ω—É –Ω–∞–¥–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ dev-chat-container —Å—Ç–∞–ª display: block
      let _this = this;
      $('#dev-chat-container').on('re_init_player', function(event) {
        _this.__init__(messages);
      });
    };

    reuse(dc_messages) {
      this.messages = dc_messages;
      this.startTime = parseFloat(this.get_create_time(0));
      this.endTime = parseFloat(this.get_create_time(this.messages_len));
      this.totalTime = this.endTime - this.startTime;
    };

    __init__(messages) {
      let dc_messages = JSON.parse(JSON.stringify(messages));

      this.messages_len = dc_messages.length-1;
      this.bar_width = $('.player__progress')[0].getBoundingClientRect().width;

      // –¥–æ–±–∞–≤–ª—è—é –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–¥–≤–∏–≥ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞ null
      this.reuse(dc_messages);
      for (let i in dc_messages) {
        if (this.get_sender_cur_pos(i) === null) {
          dc_messages[i]['create_time'] -= this.totalTime / this.bar_width;
        };
      };
      this.reuse(dc_messages);

      this.pointer_width = (this.bar_width / 100) * 1; // 1%
      $('.player__time_start').text('00:00');
      $('.player__time_end').text(this.humanize_time(this.totalTime));
      this.minOffsetX = null;
      this.maxOffsetX = null;
      this._pause = false;
      this._playing = false;
      this.currentTime = this.startTime;
      this.speed = 1;
      $('.player__button_type_speed').children().text(`${this.speed}x`);
      this.actual_pointer_offsetX = 0;
      this.remove_pointer();
      this.remove_frames();
      this.frames_offsetX = [];
      this.generate_frames();
    };

    remove_pointer() {
      let pointer = document.querySelector('.player__pointer');
      if (pointer) {
        pointer.remove();
      };
    };

    remove_frames() {
      // —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ—Ä–µ–π–º—ã –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
      $('.player__frame-container div').each(function(index, element) {
        element.remove();
      });
    };

    generate_frames() {
      // –ø—É—Å—Ç—ã–µ –∑–æ–Ω—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —à–∏—Ä–∏–Ω–µ –ø–æ–∏–Ω—Ç–µ—Ä–∞
      // —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –±–∞—Ä–∞ —Å —É—á—ë—Ç–æ–º —à–∏—Ä–∏–Ω—ã –ø–æ–∏–Ω—Ç–µ—Ä–∞
      let bar_width = this.bar_width - this.pointer_width;
      // —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Ñ—Ä–µ–π–º–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã –∑–∞–ø–∏—Å–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
      let frame_width = (bar_width / this.totalTime) / 15;
      // —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —Ñ—Ä–µ–π–º–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
      frame_width = Math.max(bar_width / 500, frame_width);
      // —Ç.–∫. –≤—Å–µ —Ñ—Ä–µ–π–º—ã –±—É–¥—É—Ç —Å–¥–≤–∏–Ω—É—Ç—ã –≤–ø—Ä–∞–≤–æ –Ω–∞ —à–∏—Ä–∏–Ω—É –ø–æ–∏–Ω—Ç–µ—Ä–∞, —É—á–∏—Ç—ã–≤–∞–µ–º —ç—Ç—É —à–∏—Ä–∏–Ω—É –≤–º–µ—Å—Ç–µ —Å —à–∏—Ä–∏–Ω–æ–π —Ñ—Ä–µ–π–º–∞
      bar_width -= this.pointer_width + frame_width;

      for (let i in this.messages) {

        let currentTime = this.get_create_time(i);

        // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Ñ—Ä–µ–π–º–∞ –Ω–∞ —Ç–∞–π–º–ª–∞–π–Ω–µ, —Å–¥–≤–∏–≥ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
        // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —à–∏—Ä–∏–Ω—ã –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞ –∏ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        let frame_offsetX = bar_width * ((currentTime - this.startTime) / this.totalTime);

        frame_offsetX += this.pointer_width; // —Å–¥–≤–∏–≥–∞–µ–º –≤—Å–µ —Ñ—Ä–µ–π–º—ã –≤–ø—Ä–∞–≤–æ –Ω–∞ —à–∏—Ä–∏–Ω—É –ø–æ–∏–Ω—Ç–µ—Ä–∞

        this.frames_offsetX.push(frame_offsetX);

        $('.player__frame-container')[0].insertAdjacentHTML('beforeEnd',
          `<div class="player__frame" draggable="false"
          style="transform: translateX(${frame_offsetX}px); width: ${frame_width}px;
          background-color:${this.get_sender_color(i)};"></div>`
        );
      };
    };

    get_chat_text(index=0) {
      return this.messages[index]['chat_text'];
    };

    get_create_time(index=0) {
      return this.messages[index]['create_time'];
    };

    get_sender_data(index=0) {
      return this.messages[index]['sender'];
    };

    get_sender_color(index=0) {
      return Object.values(this.get_sender_data(index))[0]['user_color'];
    };

    get_sender_cur_pos(index=0) {
      return Object.values(this.get_sender_data(index))[0]['cur_pos'];
    };

    play() {
      // –æ–±–Ω–æ–≤–ª—è—é –ø–æ–∑–∏—Ü–∏—é –ø–æ–∏–Ω—Ç–µ—Ä–∞ –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ–≥–æ –¥–≤–∏–≥–∞–ª–∏ –≤—Ä—É—á–Ω—É—é –≤–æ –≤—Ä–µ–º—è –ø–∞—É–∑—ã
      this.currentTime = this.calculate_time_by_offsetX(this.actual_pointer_offsetX, true);

      if (this.actual_pointer_offsetX == 0) {
        update_dev_chat_text(this.get_chat_text(0));
        update_dev_chat_cursors(this.get_sender_data(0), false);
      };

      this._playing = true;
      this._pause = false;
      this.playback_in_automatic_mode();
    };

    pause() {
      this._playing = false;
      this._pause = true;
    };

    skip() {
      this.currentTime = this.endTime;
      this.actual_pointer_offsetX = 0;

      this.set_pointer_by_offsetX(this.bar_width);
      this.set_timer_by_offsetX(this.bar_width);

      for (let i in this.messages) {
        update_dev_chat_text(this.get_chat_text(i));
        update_dev_chat_cursors(this.get_sender_data(i), false);
      };
    };

    set_speed(speed) {
      this.speed = speed;
    };

    sleep(milliseconds) {
      return new Promise(resolve => setTimeout(resolve, milliseconds));
    };

    async playback_in_automatic_mode() {

      // –µ—Å–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–∏–Ω—Ç–µ—Ä –æ–∫–∞–∑–∞–ª—Å—è –≤ –∫—Ä–∞–π–Ω–µ–π –ø—Ä–∞–≤–æ–π —Ç–æ—á–∫–µ, –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á—ë—Ç —Å –Ω–∞—á–∞–ª–∞
      let last_offsetX = this.bar_width * ((this.currentTime - this.startTime) / this.totalTime);
      if (last_offsetX >= this.maxOffsetX) {
        this.currentTime = this.startTime;
      };

      while (this._pause == false && this.currentTime < this.endTime) {

        let offsetX = this.bar_width * ((this.currentTime - this.startTime) / this.totalTime);
        this.actual_pointer_offsetX = offsetX;

        this.set_pointer_by_offsetX(offsetX);
        this.set_timer_by_offsetX(offsetX);

        this.set_text_by_offsetX(offsetX);

        // –∫–æ—Å—Ç—ã–ª—å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4–º—Å,
        // —Ç.–∫. –º–µ–Ω—å—à–µ —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ setTimeout/setInterval –Ω–µ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞—é—Ç.
        let timeStamp = Date.now();
        await this.sleep(4);
        this.currentTime += (Date.now() - timeStamp) / (1000 / this.speed);
      };

      // –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è
      if (this.currentTime >= this.endTime) {
        this._playing = false;
        $('.player__button_type_play').children().text('play_arrow');
        this.currentTime = this.startTime;
        this.actual_pointer_offsetX = 0;
      };
    };

    playback_in_manual_mode(offsetX) {
      this.actual_pointer_offsetX = offsetX;

      // –æ–±–Ω–æ–≤–ª—è—é –ø–æ–∑–∏—Ü–∏—é –ø–æ–∏–Ω—Ç–µ—Ä–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
      if (this._playing) {
        this._pause = true; // –±–ª–æ–∫–∏—Ä—É—é —Ü–∏–∫–ª –ø–æ–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–∏–Ω—Ç–µ—Ä–∞ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
        $('.player__button_type_play').children().text('play_arrow');
        this.currentTime = this.calculate_time_by_offsetX(offsetX, true);
      };

      this.set_pointer_by_offsetX(offsetX);

      this.set_text_by_offsetX(offsetX);
    };

    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
    humanize_time(seconds) {
      seconds = Math.round(seconds);

      let minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;

      let hours = Math.floor(minutes / 60);
      minutes = minutes % 60;

      if (hours > 0) {
        return `${('0'+hours).slice(-2)}:${('0'+minutes).slice(-2)}:${('0'+seconds).slice(-2)}`;
      };
      return `${('0'+minutes).slice(-2)}:${('0'+seconds).slice(-2)}`;
    };

    // –≤—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ offsetX
    calculate_time_by_offsetX(offsetX, reverse=false) {
      let progress;
      if (reverse) {
        progress = offsetX / this.bar_width; // –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞—Ä–∞ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ offsetX (–æ—Ç 0 –¥–æ 1)
      } else {
        progress = (this.bar_width - offsetX) / this.bar_width; // –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞—Ä–∞ –æ—Ç offsetX –¥–æ –∫–æ–Ω—Ü–∞ (–æ—Ç 1 –¥–æ 0)
      };
      return this.startTime + progress * this.totalTime;
    };

    // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ offsetX
    set_text_by_offsetX(offsetX) {
      for (let i in this.frames_offsetX) {
        if (offsetX > this.frames_offsetX[i]) {
          update_dev_chat_text(this.get_chat_text(i));
          update_dev_chat_cursors(this.get_sender_data(i), false);
        };
      };
    };

    // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ offsetX
    set_timer_by_offsetX(offsetX) {
      let start_time = this.calculate_time_by_offsetX(offsetX);
      let formatted_time = this.humanize_time(this.endTime - start_time);
      $('.player__time_start').text(formatted_time);
    };

    // —Å–æ–∑–¥–∞—ë–º –ª–∏–±–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è pointer
    set_pointer_by_offsetX(offsetX) {

      let pointer = document.querySelector('.player__pointer');
      if (!pointer) {
        $('.player__progress')[0].insertAdjacentHTML('beforeEnd',
          `<div draggable="false" class="player__pointer"
          style="transform: translateX(${offsetX}px);
          width: ${this.pointer_width}px; left: -${this.pointer_width / 2}px;"></div>`
        );
        pointer = document.querySelector('.player__pointer');
      };
      // –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º pointer –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É –±–∞—Ä–∞ –∏–∑–∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
      if (!this.minOffsetX || !this.maxOffsetX) {
        let pointer_shift = this.pointer_width / 2;
        this.minOffsetX = pointer_shift;
        this.maxOffsetX = this.bar_width - pointer_shift;
      };
      offsetX = Math.max(this.minOffsetX, Math.min(this.maxOffsetX, offsetX));

      pointer.style.transform = `translateX(${offsetX}px)`;

      // –¥–µ–ª–∞—é –∫–Ω–æ–ø–∫—É –ø—Ä–æ–º–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–π/–Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–∏–Ω—Ç–µ—Ä–∞
      if (offsetX >= this.maxOffsetX) {
        disable_skip_btn();
      } else {
        enable_skip_btn();
      };
    };

    bar_mouseup() {
      // –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è –ø–æ–∏–Ω—Ç–µ—Ä–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ü–∏–∫–ª
      if (this._playing) {
        $('.player__button_type_play').children().text('pause');
        this._pause = false;
        this.playback_in_automatic_mode();
      };
    };

    // –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—É –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∏—Å—Ö–æ–¥—è –∏–∑ –ø–æ–∑–∏—Ü–∏–∏
    bar_mousemove(offsetX) {
      if (this._playing && this._pause
      || !this._playing && !this._pause
      || !this._playing && this._pause) {
        this.set_timer_by_offsetX(offsetX);
      };
    };

    // –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –∑–∞–ø–∏—Å–∞–Ω–æ —Ä–∞–Ω–µ–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ pointer
    bar_mouseout() {
      this.set_timer_by_offsetX(this.actual_pointer_offsetX);
    };
  };
</script>

<script>
  let mousedown = false;

  // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è —Ñ–∏–∫—Å–∞ –±–∞–≥–∞ –∫–æ–≥–¥–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø–ª–µ–µ—Ä–∞ —Ç–∞–ø–∞–µ—à—å –¥–ª—è –ø—Ä–æ–º–æ—Ç–∫–∏
  // –∏ –ø–ª–µ–µ—Ä —Å–∞–º –ø–æ —Å–µ–±–µ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ)
  let debounce_bar_mouseup = debounce(() => { player.bar_mouseup(); }, 4);

  // –∫–æ–º–ø—å—é—Ç–µ—Ä
  $('.player__progress').on('mousedown', function(event) {
    if (event.button == 0) { // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–µ–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏
      mousedown = true;
      player.playback_in_manual_mode(event.offsetX);
    };
  });
  $(document).on('mouseup', function(event) {
    if (event.button == 0 && mousedown) {
      mousedown = false;
      debounce_bar_mouseup();
    };
  });
  // –æ–±—Ö–æ–¥ –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –º–µ–Ω—è—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∏–Ω—Ç–µ—Ä–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –≥—Ä–∞–Ω–∏—Ü –±–∞—Ä–∞
  $(document).on('mousemove', function(event) {
    if (mousedown) {
      let bar = $('.player__progress')[0];
      let offsetX = Math.round(event.clientX - bar.getBoundingClientRect().left);
      offsetX = Math.max(0, Math.min(bar.offsetWidth, offsetX));
      // let offsetY = Math.round(event.clientY - bar.getBoundingClientRect().top);
      // offsetY = Math.max(0, Math.min(bar.offsetHeight, offsetY));

      player.bar_mousemove(offsetX);
      player.playback_in_manual_mode(offsetX);
    };
  });
  $('.player__progress').on('mousemove', function(event) {
    player.bar_mousemove(event.offsetX);
  });
  $('.player__progress').on('mouseout', function(event) {
    player.bar_mouseout();
  });


  // —Å–º–∞—Ä—Ç—Ñ–æ–Ω
  $('.player__progress').on('touchstart', function(event) {
    mousedown = true;

    let offsetX = Math.round(event.changedTouches[0].clientX - this.getBoundingClientRect().left);
    offsetX = Math.max(0, Math.min(this.offsetWidth, offsetX));

    player.playback_in_manual_mode(offsetX);
  });
  $(document).on('touchend', function(event) {
    if (mousedown) {
      mousedown = false;
      debounce_bar_mouseup();
    };
  });
  $('.player__progress').on('touchmove', function(event) {
    event.preventDefault(); // –æ—Ç–º–µ–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –≤—Ä–µ–º—è –ø–æ–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–∏–Ω—Ç–µ—Ä–∞

    let offsetX = Math.round(event.changedTouches[0].clientX - this.getBoundingClientRect().left);
    offsetX = Math.max(0, Math.min(this.offsetWidth, offsetX));

    player.bar_mousemove(offsetX);
    if (mousedown) {
      player.playback_in_manual_mode(offsetX);
    };
  });
</script>

<script>
  function room_state_unlock() {

    let close_room_btn = $('#close_room_btn')[0];
    close_room_btn.classList.remove('close-room-yes');
    close_room_btn.classList.add('close-room-no');
    close_room_btn.textContent = "{% trans '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Ç' %}";

    let close_room_info = $('#close_room_info')[0];
    close_room_info.classList.remove('close-room-no');
    close_room_info.classList.add('close-room-yes');
    close_room_info.textContent = "{% trans '–ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç' %}";

    code_editor.setReadOnly(false);

    player.skip();
    remove_all_cursors();

    lock_room = false;

    let player_container = $('.player-container');
    player_container.css('display', 'none');
  };

  function room_state_lock(chat_history) {

    let close_room_btn = $('#close_room_btn')[0];
    close_room_btn.classList.remove('close-room-no');
    close_room_btn.classList.add('close-room-yes');
    close_room_btn.textContent = "{% trans '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç' %}";

    let close_room_info = $('#close_room_info')[0];
    close_room_info.classList.remove('close-room-yes');
    close_room_info.classList.add('close-room-no');
    close_room_info.textContent = "{% trans '–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç' %}";

    let player_container = $('.player-container');
    if (window.screen.width > 800) {
      player_container.css('display', 'flex');
    } else {
      player_container.css('display', 'block');
    };

    code_editor.setReadOnly(true);

    player = new Player(chat_history); // —Å–æ–∑–¥–∞—é –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤–æ –≤—Å—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–µ

    lock_room = true;
  };

  $('#close_room_btn').on('click', function(event) {
    // –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫:
    // —Å–æ–∑–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –∫–æ—Ç–æ—Ä–æ–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç—Ç–æ–≥–æ –∏–≤–µ–Ω—Ç–µ—Ä–∞
    // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å —ç—Ç–∏–º —Å–æ–∑–¥–∞—ë–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —Å –ø–æ–º–æ—â—å—é setTimeout –Ω–∞ —Å–µ–∫—É–Ω–¥—ã 2
    // –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–∞ –ø—Ä–∏—à–ª–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∏–≤–µ–Ω—Ç–µ—Ä –∏–∑–º–µ–Ω—è—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    // –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏—à–ª–æ –∑–Ω–∞—á–∏—Ç –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏—é —Ç–∞–π–º–∞—É—Ç–∞ —ç—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–≤–µ–Ω—Ç–µ—Ä
    if (lock_room) {
      chatSocket.send(JSON.stringify(
        {'room_state': 'unlock'}
      ));
    } else {
      chatSocket.send(JSON.stringify(
        {'room_state': 'lock'}
      ));
    };
  });

  $('.player__button_type_play').on('click', function(event) {
    let child = $(this).children();

    if (child.text() == 'play_arrow') {

      child.text('pause');
      enable_skip_btn();
      player.play();

    } else {
      child.text('play_arrow');
      player.pause();
    };
  });

  $('.player__button_type_speed').on('click', function(event) {
    let child = $(this).children();
    let speed;
    if (child.text() == '0.25x') { speed = 0.5; }
    else if (child.text() == '0.5x') { speed = 1; }
    else if (child.text() == '1x') { speed = 2; }
    else if (child.text() == '2x') { speed = 4; }
    else if (child.text() == '4x') { speed = 8; }
    else if (child.text() == '8x') { speed = 16; }
    else if (child.text() == '16x') { speed = 0.25; };
    child.text(`${speed}x`);
    // –∏–∑–º–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    player.set_speed(speed);
  });

  $('.player__button_type_skip').on('click', function(event) {

    $('.player__button_type_play').children().text('play_arrow');
    disable_skip_btn()
    // $('.player__pointer').remove(); // —É–¥–∞–ª—è–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –ø—Ä–æ–º–æ—Ç–∫–∏
    player.skip();
  });

  function enable_skip_btn() {
    let skip = $('.player__button_type_skip');
    skip.removeClass('disabled_skip');
    skip[0].disabled = false;
  };
  function disable_skip_btn() {
    let skip = $('.player__button_type_skip');
    skip.addClass('disabled_skip');
    skip[0].disabled = true;
  };
</script>

<script>
  // –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä
  (function() {
    let throttle = function(type, name, obj) {
      obj = obj || window;
      let running = false;
      let func = function() {
        if (running) { return; };
        running = true;
        requestAnimationFrame(function() {
          obj.dispatchEvent(new CustomEvent(name));
          running = false;
        });
      };
      obj.addEventListener(type, func);
    };
    throttle('resize', 'resize2');
  })();

  $(window).on('load', function(event) {
    // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ
    let prevCW = document.documentElement.clientWidth; // –®–∏—Ä–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞
    let prevCH = document.documentElement.clientHeight; // –í—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞

    $(window).on('resize2', function(event) {
      let curCW = document.documentElement.clientWidth;
      let curCH = document.documentElement.clientHeight;
      if (prevCW != curCW || prevCH != curCH) {
        prevCW = curCW;
        prevCH = curCH;
        // –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞—Å—à—Ç–∞–±–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ä—É—á–Ω—É—é –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–≤–µ–Ω—Ç
        // –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
        $('#dev-chat-container')[0].dispatchEvent(new Event('re_init_player'));
      };
    });
  });
</script>

<script>
  var code_editor = ace.edit("code_editor");

  code_editor.setTheme("ace/theme/cloud9_night_low_color");

  code_editor.setShowPrintMargin(false); // —É–±—Ä–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø–æ–ª–æ—Å—É –ø–æ —Ü–µ–Ω—Ç—Ä—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞

  code_editor.setOptions({
    customScrollbar: true,
    // enableAutoIndent: false, // –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π TAB
  });

  // code_editor.session.gutterRenderer = {
  //   getWidth: function(session, lastLineNumber, config) {
  //     return lastLineNumber.toString().length * config.characterWidth; // —à–∏—Ä–∏–Ω–∞ gutter
  //   },
  //   getText: function(session, row) {
  //     // return String.fromCharCode(row + 65); // –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã –∞–ª—Ñ–∞–≤–∏—Ç–∞ –≤–º–µ—Å—Ç–æ —Ü–∏—Ñ—Ä
  //     return row + 1;
  //   }
  // };

  const cursorManager = new AceCollabExt.AceMultiCursorManager(code_editor.getSession());

  const selectionManager = new AceCollabExt.AceMultiSelectionManager(code_editor.getSession());
</script>

<script>
  function search_element(id, target) {
    let found_element = null;
    $(`#${id} option`).each(function(index, element) {
      if (target == 'selected' && target in element.attributes) {
        found_element = element;
        return false;
      } else if (target != 'selected' && target == element.value) {
        found_element = element;
        return false;
      };
    });
    return found_element;
  };

  function change_select_attr(id, val) {
    var element = search_element(id, 'selected');
    if (element) { element.removeAttribute('selected'); };
    var element = search_element(id, val);
    if (element) { element.setAttribute('selected', ''); };
  };

  function update_saved_rooms(key, val) {
    let saved_rooms = JSON.parse(localStorage.getItem('saved_rooms'));
    if (saved_rooms && '{{ room_id }}' in saved_rooms) {
      saved_rooms['{{ room_id }}'][key] = val;
      localStorage.setItem('saved_rooms', JSON.stringify(saved_rooms));
    };
  };

  $('#id_programming_languages').on('input', function(event) {
    change_select_attr(this.id, event.target.value);
    code_editor.session.setMode(`ace/mode/${event.target.value}`);
    update_saved_rooms('language', event.target.value);
  });

  function set_dev_chat_language(id, lang) {
    change_select_attr(id, lang);
    code_editor.session.setMode(`ace/mode/${lang}`);
  };

  $('#id_select_pixels').on('input', function(event) {
    change_select_attr(this.id, event.target.value);
    code_editor.setFontSize(event.target.value);
    update_saved_rooms('font_size', event.target.value);
  });

  function set_dev_chat_font_size(id, font_size) {
    change_select_attr(id, font_size);
    code_editor.setFontSize(font_size);
  };
</script>

<script>
  const copy_text = new CopyText();
</script>

<script>
  const login_popup = document.querySelector("#login-popup");
  const dev_chat_container = document.querySelector("#dev-chat-container");
  const dev_chat_username = $('#dev_chat_username');
  const login_popup_btn_state = document.querySelector('#login-popup-btn');

  dev_chat_username.on('input', function(event) {
    if (event.target.value !== '') {
      login_popup_btn_state.classList.remove('disabled');
      login_popup_btn_state.classList.add('enabled');
      login_popup_btn_state.disabled = false;
    } else {
      login_popup_btn_state.classList.remove('enabled');
      login_popup_btn_state.classList.add('disabled');
      login_popup_btn_state.disabled = true;
    };
  });

  function get_random_hex_color(min=0, max=255, alpha='') {
    return '#' + get_rand_int(min, max).toString(16) + get_rand_int(min, max).toString(16) + get_rand_int(min, max).toString(16) + alpha.toString();
  };

  // https://learn.javascript.ru/websockets
  const ws_scheme = window.location.protocol == "https:" ? "wss://" : "ws://";
  const websocket_pathname = "/ws/dev-chat/" + "{{ room_id }}" + "/";
  const chatSocket = new WebSocket(ws_scheme + window.location.host + websocket_pathname);

  $('#chat-path-input')[0].value = window.location.href;

  chatSocket.onopen = function(event) {
    console.info('–ß–∞—Ç-—Å–æ–∫–µ—Ç –æ—Ç–∫—Ä—ã–ª—Å—è.');
  };
  chatSocket.onclose = function(event) {
    console.error('–ß–∞—Ç-—Å–æ–∫–µ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –∑–∞–∫—Ä—ã–ª—Å—è.');
  };

  var userid = null;
  var room_creator = null;
  var event_lock = false; // –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
  var one_time_change = false;
  var users_curs_pos = {};
  var lock_room = false;

  // —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ª—é–±–æ–º –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
  function clear_all_selections() {
    for (let user_id in selectionManager._selections) {
      selectionManager.clearSelection(user_id);
    };
  };

  function remove_all_cursors() {
    for (let user_id in cursorManager._cursors) {
      remove_cursor(user_id);
    };
  };

  function remove_cursor(user_id) {
    // –∫–æ—Å—Ç—ã–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–∞ –∫—É—Ä—Å–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π –≤—ã—à–µ–ª –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
    $('.ace-multi-cursor-tooltip').each(function(index, element) {
      if (element.textContent == cursorManager._cursors[user_id]._label) {
        element.parentElement.remove();
      };
    });
    cursorManager.removeCursor(user_id); // —É–¥–∞–ª—è–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π –≤—ã—à–µ–ª –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
  };

  function update_dev_chat_text(message) {
    // –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ code_editor –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    // –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–≤–µ–Ω—Ç change —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π event_lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
    event_lock = true;

    // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
    let cur_pos = code_editor.selection.getCursor();
    // let cur_pos = code_editor.getCursorPosition();

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä (1)
    code_editor.session.setValue(message);

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä (2)
    // let sel_text = code_editor.setValue(message);
    // code_editor.clearSelection(); // —É–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    // code_editor.selection.clearSelection();

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä (3)
    // code_editor.session.setValue('');
    // let sel_text = code_editor.setValue('');
    // let end_pos = code_editor.session.insert(cur_pos, message);

    // —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É—Ä—Å–æ—Ä–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    code_editor.selection.moveTo(cur_pos['row'], cur_pos['column']);
    // code_editor.moveCursorTo(cur_pos['row'], cur_pos['column']);
    // code_editor.gotoLine(cur_pos['row']+1, cur_pos['column']);

    // –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
    // code_editor.navigateLineEnd();

    event_lock = false;
  };

  function update_dev_chat_cursors(cursor_data, skip_self=true) {
    for (let user_id in cursor_data) {
      if (skip_self && user_id == userid) { continue; };
      let user_data = cursor_data[user_id];

      if (user_data['cur_pos']) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –¥–≤–∏–≥–∞–ª –∫—É—Ä—Å–æ—Ä
        let row = user_data['cur_pos']['row'];
        let column = user_data['cur_pos']['column'];

        // —Å–æ–∑–¥–∞—ë–º –∫—É—Ä—Å–æ—Ä –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫—Ä–æ–º–µ —Å–µ–±—è (—Ç.–∫. —Å–≤–æ–π –∫—É—Ä—Å–æ—Ä –Ω–∞–º –≤–∏–¥–µ—Ç—å –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
        if (user_id in cursorManager._cursors) {
        } else {
          cursorManager.addCursor(
            user_id,
            user_data['username'],
            user_data['user_color'],
            { row: row, column: column }
          );
        };
        cursorManager.setCursor(user_id, { row: row, column: column });

        if (skip_self) {
          users_curs_pos[user_id] = {'row': row, 'column': column};
        };

        // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –∫—É—Ä—Å–æ—Ä–∞ –≤ –µ–≥–æ –∏—Å—Ç–∏–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        // –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –ø–ª–µ–µ—Ä–æ–º
        if (!skip_self && user_id == userid) {
          code_editor.selection.moveTo(row, column);
        };
      } else {
        // –ø—Ä–∏ –æ—Ç–º–æ—Ç–∫–µ –ø–ª–µ–µ—Ä–∞ –Ω–∞–∑–∞–¥, —É–±–∏—Ä–∞–µ–º –∫—É—Ä—Å–æ—Ä—ã –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –¥–æ–ª–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
        if (!skip_self && user_id in cursorManager._cursors) {
          remove_cursor(user_id);
        };
      };
    };
  };

  chatSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);

    if (data.userid) {
      userid = data.userid;
    };

    if (data.room_creator) {
      room_creator = data.room_creator;

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–º–Ω–∞—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–æ–º–Ω–∞—Ç—ã
      if (room_creator == userid) {
        $('#close_room_btn').css('display', 'block');
      } else {
        $('#close_room_info').css('display', 'block');
      };
    };

    if (data.chat_history) {
      if (data.chat_history == 'unlock') {
        room_state_unlock();
      } else {
        room_state_lock(data.chat_history);
      };
    };

    if (data.cursor_data) {
      update_dev_chat_cursors(data.cursor_data, true);
    };

    if (data.selection_data) {
      let user_id = Object.keys(data.selection_data)[0];
      if (user_id != userid) { // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–∏
        let user_data = Object.values(data.selection_data)[0];
        let sel_range = user_data['selection_range'];
        let ace_range = new ace.Range(
          sel_range['start']['row'],
          sel_range['start']['column'],
          sel_range['end']['row'],
          sel_range['end']['column']
        )
        if (user_id in selectionManager._selections) {
        } else {
          selectionManager.addSelection(user_id, user_data['username'], user_data['user_color'], ace_range);
        };
        selectionManager.setSelection(user_id, ace_range);
      };
    };

    if (data.message != undefined) { // —É—Å–ª–æ–≤–∏–µ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
      update_dev_chat_text(data.message);
      clear_all_selections();

      // –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ—Å—Ç—ã–ª—å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∫–æ–º–Ω–∞—Ç—É –Ω–∞ –≤—Ç–æ—Ä–æ–π –≤–∫–ª–∞–¥–∫–µ
      if (one_time_change == false) {
        one_time_change = true;
        update_saved_rooms('message', data.message);
      };
    };

    if (data.active_consumers) {

      // —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –Ω–∏–∫–Ω–µ–π–º—ã –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
      $('#active-clients span').each(function(index, element) {
        element.remove();
      });

      for (let user_id in cursorManager._cursors) {
        if (user_id in data.active_consumers) {
        } else {
          remove_cursor(user_id);
        };
      };

      for (let user_id in selectionManager._selections) {
        if (user_id in data.active_consumers) {
        } else {
          selectionManager.removeSelection(user_id);
        };
      };

      for (let user_id in data.active_consumers) {
        if (data.active_consumers[user_id]['username'] == null) { continue; };

        for (let i = 0; i < data.active_consumers[user_id]['page_count']; i++) {
          let username = data.active_consumers[user_id]['username'];
          if (i > 0) {
            username += `(${String(i)})`;
          };
          if (user_id == room_creator) {
            username = 'üëë' + username;
          };
          document.getElementById('active-clients').insertAdjacentHTML('beforeEnd',
            `<span id="${user_id}" style="color: ${data.active_consumers[user_id]['user_color']};
            margin-left: 15px;">${username}</span>`
          );
        };
      };
    };
  };

  const time_delta = 1000*60*60*24*30; // 30 –¥–Ω–µ–π
  const cookie_saved_room_expires = 30; // 30 –¥–Ω–µ–π

  const current_datetime = Date.now(); // —Ä–∞–∑–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ +new Date();

  let saved_rooms = localStorage.getItem('saved_rooms');
  if (saved_rooms) {

    saved_rooms = JSON.parse(saved_rooms);

    if ('{{ room_id }}' in saved_rooms) {
      set_dev_chat_language('id_programming_languages', saved_rooms['{{ room_id }}']['language']);
      set_dev_chat_font_size('id_select_pixels', saved_rooms['{{ room_id }}']['font_size']);

      saved_rooms['{{ room_id }}']['time_stamp'] = current_datetime;

      dev_chat_container.style.display = 'block';
      code_editor.focus();
    } else {
      login_popup.style.display = 'block';
      dev_chat_username.focus();
    };

    for (let room_id in saved_rooms) {
      if (current_datetime - time_delta >= saved_rooms[room_id]['time_stamp']) { // 14:00 - 1:00 = 13:00 >= 13:00
      // if (current_datetime - saved_rooms[room_id]['time_stamp'] >= time_delta) { // 14:00 - 13:00 = 1:00 >= 1:00
        delete saved_rooms[room_id];
      };
    };

    localStorage.setItem('saved_rooms', JSON.stringify(saved_rooms));
  } else {
    login_popup.style.display = 'block';
    dev_chat_username.focus();
  };

  document.querySelector('#login-popup-btn').onclick = function(event) {
    const username = document.querySelector('#dev_chat_username').value;
    const user_color = get_random_hex_color(105);

    chatSocket.send(JSON.stringify(
      {'user_data': {'username': username, 'user_color': user_color}}
    ));

    set_dev_chat_language('id_programming_languages', 'plain_text');
    set_dev_chat_font_size('id_select_pixels', '17px');

    cookie_saved_room = {
      'userid': userid,
      'username': username,
      'user_color': user_color
    };


    Cookies.set('dev_chat_saved_room', cookie_saved_room, {
      expires: cookie_saved_room_expires,
      domain: "{{ PARENT_DOMAIN }}",
      path: websocket_pathname
    });


    let saved_rooms = localStorage.getItem('saved_rooms');
    if (saved_rooms) {
      saved_rooms = JSON.parse(saved_rooms);
      saved_rooms['{{ room_id }}'] = {
        'time_stamp': current_datetime,
        'username': username,
        'language': 'plain_text',
        'font_size': '17px',
        'message': ''
      };
    } else {
      saved_rooms = {
        '{{ room_id }}': {
          'time_stamp': current_datetime,
          'username': username,
          'language': 'plain_text',
          'font_size': '17px',
          'message': ''
        }
      };
    };
    localStorage.setItem('saved_rooms', JSON.stringify(saved_rooms));

    login_popup.style.display = 'none';
    dev_chat_container.style.display = 'block';
    code_editor.focus();

    // –ø—Ä–∏ –≤–≤–æ–¥–µ –Ω–∏–∫–Ω–µ–π–º–∞ –≤—Ä—É—á–Ω—É—é –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–≤–µ–Ω—Ç
    // –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
    $('#dev-chat-container')[0].dispatchEvent(new Event('re_init_player'));
  };

  // https://learn.javascript.ru/localstorage
  // –ø—Ä–∏–Ω–∏–º–∞—é –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —á–∞—Ç –Ω–∞ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ (–Ω–∞ –≤–∫–ª–∞–¥–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ –∏–≤–µ–Ω—Ç –Ω–µ —Ñ–∞–π—Ä–∏—Ç—Å—è)
  window.onstorage = (event) => {
    if (event.key == 'saved_rooms') {
      // if (event.storageArea != localStorage) return;
      let saved_rooms = JSON.parse(event.newValue);

      login_popup.style.display = 'none';
      dev_chat_container.style.display = 'block';

      set_dev_chat_language('id_programming_languages', saved_rooms['{{ room_id }}']['language']);
      set_dev_chat_font_size('id_select_pixels', saved_rooms['{{ room_id }}']['font_size']);

      update_dev_chat_text(saved_rooms['{{ room_id }}']['message']);
    };
  };

  // –ø—Ä–∏—à–ª–æ—Å—å –ø—Ä–∏–∫—Ä—É—Ç–∏—Ç—å –º–∏–∫—Ä–æ –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∏–≤–µ–Ω—Ç
  // –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã—Å—Ç—Ä–µ–ª–µ –≤—ã–∑—ã–≤–∞—è getValue –ø–æ–ª—É—á–∞–ª –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ''
  function send_curs_pos_and_message_data(event) {
    if (users_curs_pos) {
      for (let user_id in users_curs_pos) {
        if (user_id in cursorManager._cursors) {
          let row = users_curs_pos[user_id]['row'];
          let column = users_curs_pos[user_id]['column'];
          // –ø–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –¥–≤–∏–∂–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞ –∫–∞–∫ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
          // –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, –∑–Ω–∞—á–∏—Ç –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–¥–≤–∏–Ω—É—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ª—é–±–æ–π –∏–∑ –ª–∏–Ω–∏–π
          const lines_count = code_editor.session.getLength()-1; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
          if (row > lines_count) {
            row = lines_count;
            // –∫–æ—Å—Ç—ã–ª—å –¥–ª—è –∑–∞–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è –Ω–∞ –¥–ª–∏–Ω–Ω—É —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
            if (event.start.row == lines_count) { column = code_editor.session.getLine(row).length; };
          } else {
          // –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, –∏ –¥–ª–∏–Ω–Ω–∞ —Å—Ç—Ä–æ–∫–∏ –±–æ–ª—å—à–µ —á–µ–º –ø–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
          // –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–∞ —Å—Ç—Ä–æ–∫–∏ –º–µ–Ω—å—à–µ —á–µ–º –ø–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ –ø–æ–∑–∏—Ü–∏—é —Ä–∞–≤–Ω—É—é –¥–ª–∏–Ω–Ω–µ —Å—Ç—Ä–æ–∫–∏
            const line_length = code_editor.session.getLine(row).length; // –¥–ª–∏–Ω–Ω–∞ —Å—Ç—Ä–æ–∫–∏
            if (column > line_length) { column = line_length; };
          };
          cursorManager.setCursor(user_id, { row: row, column: column });
          users_curs_pos[user_id]['row'] = row;
          users_curs_pos[user_id]['column'] = column;
        };
      };
      clear_all_selections();
      chatSocket.send(JSON.stringify(
        {'users_curs_pos': users_curs_pos}
      ));
    };

    let message = code_editor.session.getValue();
    // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∫–æ—Ç–æ—Ä—ã–π –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å
    // –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ–∫—Å—Ç –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    chatSocket.send(JSON.stringify(
      {'message': message}
    ));
    // –Ω–æ —Ç.–∫. —É –º–µ–Ω—è –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–æ–∫, –Ω–∞–¥–æ —Å–æ–æ–±—â–∏—Ç—å –¥—Ä—É–≥–∏–º –≤–∫–ª–∞–¥–∫–∞–º
    // —á—Ç–æ —Ç–µ–∫—Å—Ç –æ–±–Ω–æ–≤–∏–ª—Å—è —Å –ø–æ–º–æ—â—å—é –∏–≤–µ–Ω—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
    update_saved_rooms('message', message); // –∑–∞–ø–∏—Å—ã–≤–∞—é –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —á–∞—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
  };
  let debounce_send_curs_pos_and_message_data = debounce(send_curs_pos_and_message_data, 4);

  code_editor.session.on('change', function(event) {
    // –∫–æ–≥–¥–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ –º–Ω–æ–π –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –ø–∏—à–µ—Ç –≤ —á–∞—Ç
    // –æ–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –∏–≤–µ–Ω—Ç –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ update_dev_chat_text
    // –∏ —è —Ç–µ—Ä—è—é —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∑–¥–µ—Å—å –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–∏–º–æ —É—Å–ª–æ–≤–∏—è

    if (!event_lock) {
      debounce_send_curs_pos_and_message_data(event);
    };
  });

  // –ø—Ä–∏—à–ª–æ—Å—å –ø—Ä–∏–∫—Ä—É—Ç–∏—Ç—å –º–∏–∫—Ä–æ –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∏–≤–µ–Ω—Ç –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö
  // –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã—Å—Ç—Ä–µ–ª–µ –≤—ã–∑—ã–≤–∞—è getCursor –ø–æ–ª—É—á–∞–ª –∑–Ω–∞—á–µ–Ω–∏–µ —è–≤–ª—è—é—â–µ–µ—Å—è
  // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫—É—Ä—Å–æ—Ä
  function send_cur_pos_data() {
    let cur_pos = code_editor.selection.getCursor();
    let cur_pos_data = {};
    cur_pos_data[userid] = {'row': cur_pos['row'], 'column': cur_pos['column']};
    chatSocket.send(JSON.stringify(
      {'users_curs_pos': cur_pos_data}
    ));
  };
  let debounce_send_cur_pos_data = debounce(send_cur_pos_data, 4);

  code_editor.session.selection.on('changeCursor', function(event) {
    if (!event_lock && !lock_room) {
      debounce_send_cur_pos_data();
    };
  });

  // –∏–≤–µ–Ω—Ç —Ñ–∞–π—Ä–∏—Ç—Å—è –æ—Ç –ª—é–±–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –Ω–æ –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–ø–æ–π–º–∞—Ç—å –∏–º–µ–Ω–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
  // –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–∫—Ä–æ –∑–∞–¥–µ—Ä–∂–∫—É –∏ –º–µ—Ç–æ–¥ getTextRange –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
  let prev_sel_text = '';
  function send_sel_range_data() {
    let sel_range = code_editor.getSelectionRange();
    let sel_text = code_editor.session.getTextRange(sel_range);
    if (prev_sel_text != sel_text) {
      chatSocket.send(JSON.stringify(
        {'selection_range': sel_range}
      ));
    };
    prev_sel_text = sel_text;
  };
  let debounce_send_sel_range_data = debounce(send_sel_range_data, 4);

  code_editor.session.selection.on('changeSelection', function(event) {
    if (!event_lock && !lock_room) {
      debounce_send_sel_range_data();
    };
  });
</script>
{% endblock %}
